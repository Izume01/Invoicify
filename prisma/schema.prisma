// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}


enum InvoiceStatus {
  DRAFT
  GENERATING
  READY
  ERROR
}

enum InvoiceDiscountType {
  PERCENTAGE
  FIXED
}

model User {
  id          String    @id @default(cuid())
  clerkUserId String    @unique
  email       String?
  name        String?
  imageUrl    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  invoices    Invoice[]
}

model Invoice {
  id          String         @id @default(cuid())
  userId      String
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  clerkUserId String

  title         String
  status        InvoiceStatus @default(DRAFT)
  prompt        String?
  sourceText    String?
  invoiceNumber String        @unique
  currency      String        @default("USD")
  issueDate     DateTime
  dueDate       DateTime

  fromName    String
  fromEmail   String
  fromAddress String

  billToName    String
  billToEmail   String
  billToAddress String

  notes    String?
  subtotal Decimal @db.Decimal(12, 2)
  discountType InvoiceDiscountType @default(PERCENTAGE)
  discountRate Decimal @default(0) @db.Decimal(5, 2)
  discountAmount Decimal @default(0) @db.Decimal(12, 2)
  taxRate  Decimal @default(0) @db.Decimal(5, 2)
  taxAmount Decimal @default(0) @db.Decimal(12, 2)
  total    Decimal @db.Decimal(12, 2)

  rawJson Json

  items    InvoiceItem[]
  versions InvoiceVersion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([clerkUserId])
}

model InvoiceItem {
  id        String   @id @default(cuid())
  invoiceId String
  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  name        String
  description String?
  quantity    Int
  unitPrice   Decimal @db.Decimal(12, 2)
  lineTotal   Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model InvoiceVersion {
  id          String  @id @default(cuid())
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  version     Int
  sourcePrompt String
  snapshot    Json
  createdAt   DateTime @default(now())

  @@unique([invoiceId, version])
}
